#!/bin/bash
set -euo pipefail

# Force only the specific test
export RUN_ALL=0
export LIST_FILE_DIFF="tests/benchmarks/test_latency_cli.py"

# Ensure precompiled wheels are used if available (or rebuild if needed)
export VLLM_USE_PRECOMPILED=0  # set to 1 if you want to skip building wheels

# Docker image tag (temporary local)
DOCKER_IMAGE="vllm-test-minimal:latest"

# Build Docker image for testing (test target builds wheel etc.)
docker build -f docker/Dockerfile \
    --build-arg max_jobs=16 \
    --build-arg USE_SCCACHE=1 \
    --build-arg buildkite_commit=local \
    --target test \
    --tag $DOCKER_IMAGE \
    .

# Run the specific test inside Docker
docker run --rm -v "$(pwd)":/vllm-workspace -w /vllm-workspace $DOCKER_IMAGE \
    pytest tests/benchmarks/test_latency_cli.py -v
