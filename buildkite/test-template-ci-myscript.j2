#!/bin/bash
set -euo pipefail

# Hardcode single test
export RUN_ALL=0
export LIST_FILE_DIFF="tests/benchmarks/test_latency_cli.py"

# Precompiled wheels (optional)
export VLLM_USE_PRECOMPILED=1

# Docker image
DOCKER_IMAGE="vllm-test-minimal:latest"

# Build Docker image for testing
docker build -f docker/Dockerfile \
    --build-arg max_jobs=16 \
    --build-arg USE_SCCACHE=1 \
    --build-arg buildkite_commit=local \
    --target test \
    --tag $DOCKER_IMAGE \
    .

# Run only the specific test file
docker run --rm -v "$(pwd)":/vllm-workspace -w /vllm-workspace $DOCKER_IMAGE \
    pytest tests/benchmarks/test_latency_cli.py -v
