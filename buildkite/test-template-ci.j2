{% set docker_image = "public.ecr.aws/q9t5s3a7/vllm-ci-test-repo:$BUILDKITE_COMMIT" %}
{% if branch == "main" %}
{% set docker_image = "public.ecr.aws/q9t5s3a7/vllm-ci-postmerge-repo:$BUILDKITE_COMMIT" %}
{% set docker_image_latest = "public.ecr.aws/q9t5s3a7/vllm-ci-postmerge-repo:latest" %}
{% endif %}
{% set default_working_dir = "/vllm-workspace/tests" %}
{% set hf_home_fsx = "/fsx/hf_cache" %}

steps:
  # Build base test image
  - label: ":docker: build image"
    key: image-build
    agents:
      {% if branch == "main" %}
      queue: cpu_queue_postmerge_us_east_1
      {% else %}
      queue: cpu_queue_premerge_us_east_1
      {% endif %}
    commands:
      - "aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/q9t5s3a7"
      - |
        #!/bin/bash
        if [[ -z $(docker manifest inspect {{ docker_image }}) ]]; then
          echo "Image not found, proceeding with build..."
        else
          echo "Image found"
          exit 0
        fi
      - >
        docker build --file docker/Dockerfile
        --build-arg max_jobs=16
        --build-arg buildkite_commit=$BUILDKITE_COMMIT
        --build-arg USE_SCCACHE=1
        --tag {{ docker_image }}
        --target test
        --progress plain .
      - "docker push {{ docker_image }}"
      {% if branch == "main" %}
      - "docker tag {{ docker_image }} {{ docker_image_latest }}"
      - "docker push {{ docker_image_latest }}"
      {% endif %}
    env:
      DOCKER_BUILDKIT: "1"

  # Run Metrics Tests only
  {% for step in steps %}
  {% if step.metrics_test == true %}
  - label: "{{ step.label }}"
    depends_on: image-build
    soft_fail: {{ step.soft_fail or false }}
    plugins:
      - docker#v5.2.0:
          image: {{ docker_image }}
          always-pull: true
          propagate-environment: true
          gpus: all
          command:
            - "bash"
            - "-xc"
            - "cd {{ step.working_dir or default_working_dir }} && {{ step.command or (step.commands | join(' && ')) }}"
          environment:
            - HF_HOME={{ hf_home_fsx }}
            - VLLM_USAGE_SOURCE=ci-test
    {% endif %}
  {% endfor %}
