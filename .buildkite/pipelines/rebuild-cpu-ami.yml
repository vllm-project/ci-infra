# Buildkite pipeline for rebuilding the CPU build AMI
#
# This pipeline is scheduled to run daily at 6 AM UTC to keep the
# Docker layer cache fresh. The schedule is managed via Terraform.
#
# The pipeline uses the dedicated packer_build_queue which has EC2 permissions
# to create and manage AMIs and update SSM parameters.
#
# Automation Flow:
#   1. Build AMI in us-east-1
#   2. Update SSM parameter with new AMI ID
#   3. New instances automatically use the latest AMI (via SSM dynamic reference)

env:
  SSM_PARAM_US_EAST_1: "/buildkite/cpu-build-ami/us-east-1"
  BUILDKITE_STACK_VERSION: "6.21.0"

steps:
  - label: ":packer: Build CPU AMI"
    key: build-ami
    command:
      - |
        set -euo pipefail
        cd packer/cpu

        # Ensure yq is available
        if ! command -v yq &> /dev/null; then
          echo "Installing yq..."
          sudo wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
        fi

        echo "--- :cloudformation: Fetching base AMI from Buildkite stack v$${BUILDKITE_STACK_VERSION}"

        STACK_URL="https://s3.amazonaws.com/buildkite-aws-stack/v$${BUILDKITE_STACK_VERSION}/aws-stack.yml"

        # Extract AMI ID for us-east-1 x86_64 from CloudFormation template
        SOURCE_AMI=$$(curl -s "$$STACK_URL" | yq '.Mappings.AWSRegion2AMI.us-east-1.linuxamd64')

        if [[ -z "$$SOURCE_AMI" || ! "$$SOURCE_AMI" =~ ^ami-[a-f0-9]+$$ ]]; then
          echo "Error: Failed to extract valid AMI from stack template"
          echo "Got: $$SOURCE_AMI"
          exit 1
        fi

        echo "Using base AMI: $$SOURCE_AMI (from Buildkite stack v$${BUILDKITE_STACK_VERSION})"

        echo "--- :packer: Building AMI"
        packer init .
        packer build -var "source_ami=$$SOURCE_AMI" buildkite-cpu-ami.pkr.hcl

        echo "--- :aws: Extracting AMI ID"

        if [[ ! -f manifest.json ]]; then
          echo "Error: manifest.json not found"
          exit 1
        fi

        US_EAST_1_AMI=$$(jq -r '.builds[-1].artifact_id | split(":")[1] // empty' manifest.json)

        if [[ -z "$$US_EAST_1_AMI" ]]; then
          echo "Error: Failed to extract AMI ID from manifest.json"
          cat manifest.json
          exit 1
        fi

        if [[ ! "$$US_EAST_1_AMI" =~ ^ami-[a-f0-9]+$$ ]]; then
          echo "Error: Invalid AMI ID format: $$US_EAST_1_AMI"
          exit 1
        fi

        echo "us-east-1 AMI: $$US_EAST_1_AMI"
        buildkite-agent meta-data set "ami-us-east-1" "$$US_EAST_1_AMI"
    agents:
      queue: packer_build_queue
    timeout_in_minutes: 60
    retry:
      automatic:
        - exit_status: -1  # Agent/infrastructure failures only
          limit: 1

  - label: ":aws: Update SSM Parameter"
    key: update-ssm
    command:
      - |
        echo "--- :ssm: Updating SSM parameter with new AMI ID"

        US_EAST_1_AMI=$$(buildkite-agent meta-data get "ami-us-east-1")

        echo "Updating $${SSM_PARAM_US_EAST_1} -> $$US_EAST_1_AMI"
        aws ssm put-parameter \
          --name "$${SSM_PARAM_US_EAST_1}" \
          --value "$$US_EAST_1_AMI" \
          --type String \
          --overwrite \
          --region us-east-1

        echo "SSM parameter updated successfully"
    agents:
      queue: packer_build_queue
    depends_on: build-ami
